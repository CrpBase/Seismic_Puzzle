<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Seismic Puzzle</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <style>
    :root { --bg: #FAF7F2; --line: #EAE3D9; --text: #141414; --primary: #E6533C; --primary-light: #FCE9E6; }
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: "Inter", "Arial", sans-serif; font-size: 16px; font-weight: 500; }
    * { box-sizing: border-box; }
    .abs { position: absolute; }
    .v { display: flex; flex-direction: column; }
    .h { display: flex; flex-direction: row; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .menu { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 8px 32px -4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 12px; min-width: 320px; max-width: 90vw; }
    #canvas { display: none; position: absolute; top: 50%; left: 50%; background: #eee; }
    .btn { background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 12px 16px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn:hover { border-color: var(--primary); color: var(--primary); }
    .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
    .btn.primary:hover { background: #C7422C; border-color: #C7422C; }
    #winOverlay .btn.primary { background: linear-gradient(135deg, #A926D3 0%, #E32E89 100%); border: none; }
    #winOverlay .btn.primary:hover { opacity: 0.9; }
    .stats { display: flex; gap: 24px; }
  </style>
</head>
<body>
  <div class="menu" id="menu">
    <h1>Seismic Puzzle</h1>
    <p>Select puzzle size:</p>
    <div class="h" style="gap:12px">
      <button class="btn" onclick="setSize(3)">3x3</button>
      <button class="btn" onclick="setSize(4)">4x4</button>
      <button class="btn" onclick="setSize(5)">5x5</button>
    </div>
    <div class="stats">
      <div class="v">
        <span style="font-weight:700" id="time">00:00.0</span>
        <span style="font-size:12px;color:#888">Time</span>
      </div>
      <div class="v">
        <span style="font-weight:700" id="moves">0</span>
        <span style="font-size:12px;color:#888">Moves</span>
      </div>
    </div>
    <button class="btn primary" id="startBtn">Start</button>
    <button class="btn" id="resetBtn" style="display:none">Reset</button>
    <input type="file" id="imgUp" accept="image/*" style="display:none">
    <button class="btn" id="uploadBtn">Upload Image</button>
  </div>

  <canvas id="canvas"></canvas>

  <div class="overlay" id="winOverlay" style="display:none">
    <div class="menu">
      <h1 style="margin:0 0 12px 0">Great job!</h1>
      <div class="v" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
        <canvas id="shareCanvas" width="800" height="420" style="border:1px solid var(--line);border-radius:12px;max-width:420px;width:100%"></canvas>
        <div class="v" style="min-width:220px">
          <button class="btn primary" id="shareXBtn">Share on X</button>
          <button class="btn" id="downloadShareBtn">Download image</button>
          <button class="btn" id="okBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="backgroundMusic" loop src="background-music.mp3"></audio>

  <script>
    (function() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const menu = document.getElementById('menu');
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      const uploadBtn = document.getElementById('uploadBtn');
      const imgUp = document.getElementById('imgUp');
      const timeEl = document.getElementById('time');
      const movesEl = document.getElementById('moves');
      const okBtn = document.getElementById('okBtn');

      let size = 3;
      let tileSize;
      let board = [];
      let empty = { x: 0, y: 0 };
      let img = new Image();
      img.src = 'https://uploads-ssl.webflow.com/6478628a885a7c20c4f80f33/66964a2d7494a3e211832049_Seismic_Puzzle_Christmas_L.png'; // Default image
      img.onload = () => autoShuffleSoon(40);

      let moves = 0;
      let timer;
      let startTime;
      let isPlaying = false;

      function setSize(newSize) {
        size = newSize;
        resetGame();
      }
      window.setSize = setSize;

      function initBoard() {
        board = [];
        for (let y = 0; y < size; y++) {
          for (let x = 0; x < size; x++) {
            board.push({ x, y, num: y * size + x });
          }
        }
        empty = { x: size - 1, y: size - 1 };
        board.pop(); // Remove the last piece
      }

      function shuffleBoard() {
        for (let i = 0; i < 1000; i++) {
          const neighbors = getNeighbors(empty.x, empty.y);
          const randomNeighbor = neighbors[Math.floor(Math.random() * neighbors.length)];
          swap(empty, randomNeighbor);
          empty = randomNeighbor;
        }
        if (isSolved()) shuffleBoard();
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < board.length; i++) {
          const piece = board[i];
          const sX = (piece.num % size) * (img.width / size);
          const sY = Math.floor(piece.num / size) * (img.height / size);
          const sW = img.width / size;
          const sH = img.height / size;
          ctx.drawImage(img, sX, sY, sW, sH, piece.x * tileSize, piece.y * tileSize, tileSize, tileSize);
        }
      }

      function getNeighbors(x, y) {
        const neighbors = [];
        if (x > 0) neighbors.push({ x: x - 1, y });
        if (x < size - 1) neighbors.push({ x: x + 1, y });
        if (y > 0) neighbors.push({ x, y: y - 1 });
        if (y < size - 1) neighbors.push({ x, y: y + 1 });
        return neighbors;
      }

      function swap(pos1, pos2) {
        const piece1 = board.find(p => p.x === pos1.x && p.y === pos1.y);
        const piece2 = board.find(p => p.x === pos2.x && p.y === pos2.y);
        if (piece1) {
          piece1.x = pos2.x;
          piece1.y = pos2.y;
        }
        if (piece2) {
          piece2.x = pos1.x;
          piece2.y = pos1.y;
        }
      }

      function isSolved() {
        for (let i = 0; i < board.length; i++) {
          const piece = board[i];
          if (piece.x !== piece.num % size || piece.y !== Math.floor(piece.num / size)) {
            return false;
          }
        }
        return true;
      }

      function updateTimer() {
        const diff = Date.now() - startTime;
        const minutes = Math.floor(diff / 60000).toString().padStart(2, '0');
        const seconds = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
        const milliseconds = Math.floor((diff % 1000) / 100).toString();
        timeEl.textContent = `${minutes}:${seconds}.${milliseconds}`;
      }

      function startGame() {
        isPlaying = true;
        moves = 0;
        movesEl.textContent = moves;
        startTime = Date.now();
        timer = setInterval(updateTimer, 100);
        menu.style.display = 'none';
        canvas.style.display = 'block';
        resetBtn.style.display = 'block';
        resizeCanvas();
        shuffleBoard();
        draw();
      }

      function resetGame() {
        isPlaying = false;
        clearInterval(timer);
        timeEl.textContent = "00:00.0";
        movesEl.textContent = "0";
        menu.style.display = 'flex';
        canvas.style.display = 'none';
        resetBtn.style.display = 'none';
        initBoard();
      }

      function resizeCanvas() {
        const maxW = window.innerWidth - 40;
        const maxH = window.innerHeight - 40;
        const canvasSize = Math.min(maxW, maxH, 600);
        canvas.width = canvasSize;
        canvas.height = canvasSize;
        canvas.style.transform = `translate(-50%, -50%)`;
        tileSize = canvasSize / size;
        if(isPlaying) draw();
      }

      canvas.addEventListener('click', (e) => {
        if (!isPlaying) return;
        const rect = canvas.getBoundingClientRect();
        const clickX = Math.floor((e.clientX - rect.left) / tileSize);
        const clickY = Math.floor((e.clientY - rect.top) / tileSize);
        const neighbors = getNeighbors(empty.x, empty.y);
        const clickedNeighbor = neighbors.find(n => n.x === clickX && n.y === clickY);
        if (clickedNeighbor) {
          swap(empty, clickedNeighbor);
          empty = clickedNeighbor;
          moves++;
          movesEl.textContent = moves;
          draw();
          if (isSolved()) {
            onWin();
          }
        }
      });
      
      uploadBtn.addEventListener('click', () => imgUp.click());
      imgUp.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      function onWin() {
        isPlaying = false;
        clearInterval(timer);
        try {
          const music = document.getElementById('backgroundMusic');
          if (music && !music.paused) {
            music.pause();
            music.currentTime = 0;
          }
        } catch (e) {
          console.warn("Error stopping music", e);
        }
        generateShare();
      }
      
      function generateShare() {
        try {
          const sc = document.getElementById('shareCanvas');
          const ctx = sc.getContext('2d');
          sc.width = 800;
          sc.height = 420;
          const W = sc.width, H = sc.height, pad = 20;

          ctx.fillStyle = "#381042";
          ctx.fillRect(0, 0, W, H);

          const rightW = 340;
          const imgBox = { x: pad, y: pad, w: W - rightW - 2 * pad, h: H - 2 * pad };

          function roundRectPath(x, y, w, h, r = 12) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
          }

          ctx.save();
          roundRectPath(imgBox.x, imgBox.y, imgBox.w, imgBox.h, 20);
          ctx.clip();

          if (img && img.complete) {
            const iw = img.naturalWidth || img.width;
            const ih = img.naturalHeight || img.height;
            const scale = Math.max(imgBox.w / iw, imgBox.h / ih);
            const dw = iw * scale;
            const dh = ih * scale;
            const dx = imgBox.x + (imgBox.w - dw) / 2;
            const dy = imgBox.y + (imgBox.h - dh) / 2;
            ctx.drawImage(img, dx, dy, dw, dh);
          } else {
            ctx.fillStyle = "#f2f2f2";
            ctx.fillRect(imgBox.x, imgBox.y, imgBox.w, imgBox.h);
          }
          
          ctx.restore();

          const rX = imgBox.x + imgBox.w + pad;
          const name = "crpbase"; 

          ctx.fillStyle = "rgba(0,0,0,0.2)";
          ctx.font = "700 28px Inter, Arial";
          ctx.fillText("Seismic Puzzle", rX + 1, pad + 31);
          ctx.fillStyle = "#FFFFFF";
          ctx.fillText("Seismic Puzzle", rX, pad + 30);

          ctx.fillStyle = "rgba(255,255,255,0.7)";
          ctx.font = "800 18px Inter, Arial";
          ctx.fillText("for @seismicsys", rX, pad + 58);

          ctx.fillStyle = "rgba(255,255,255,0.6)";
          ctx.font = "600 14px Inter, Arial";
          ctx.fillText("Player", rX, pad + 118);
          ctx.fillStyle = "#FFFFFF";
          ctx.font = "700 20px Inter, Arial";
          ctx.fillText(name, rX, pad + 140);

          ctx.fillStyle = "rgba(255,255,255,0.6)";
          ctx.font = "600 14px Inter, Arial";
          ctx.fillText("Time", rX, pad + 176);
          ctx.fillStyle = "#FFFFFF";
          ctx.font = "700 20px Inter, Arial";
          ctx.fillText(timeEl.textContent.trim(), rX, pad + 198);

          ctx.fillStyle = "rgba(255,255,255,0.6)";
          ctx.font = "600 14px Inter, Arial";
          ctx.fillText("Moves", rX, pad + 234);
          ctx.fillStyle = "#FFFFFF";
          ctx.font = "700 20px Inter, Arial";
          ctx.fillText(moves.toString(), rX, pad + 256);

          ctx.fillStyle = "rgba(255,255,255,0.6)";
          ctx.font = "500 14px Inter, Arial";
          ctx.fillText("Try to beat my time â†’", rX, H - pad - 56);
          ctx.fillStyle = "#FFFFFF";
          ctx.font = "700 18px Inter, Arial";
          ctx.fillText("crpbase.github.io/Seismic_Puzzle", rX, H - pad - 28);
          
          document.getElementById('winOverlay').style.display = 'flex';

        } catch (e) {
          console.warn("generateShare error", e);
        }
      }

      let shuffleTimeout;
      function autoShuffleSoon(delay){
        clearTimeout(shuffleTimeout);
        shuffleTimeout = setTimeout(()=>{
          if(!isPlaying) startGame();
          else shuffleBoard();
          draw();
        }, delay||60);
      }

      if(startBtn){
        startBtn.addEventListener('click', () => {
            const music = document.getElementById('backgroundMusic');
            if (music.paused) {
                music.play().catch(e => console.warn("Audio play failed. User interaction needed.", e));
            }
            autoShuffleSoon(80);
        }, true);
      }
      
      if(resetBtn){
        resetBtn.addEventListener('click', ()=> autoShuffleSoon(40), true);
      }
      
      if(okBtn){
        okBtn.addEventListener('click', ()=> {
          document.getElementById('winOverlay').style.display = 'none';
          resetGame();
        }, true);
      }
      
      document.getElementById('downloadShareBtn').addEventListener('click', ()=>{
        const sc=document.getElementById('shareCanvas'); const a=document.createElement('a');
        a.href=sc.toDataURL('image/png'); a.download='seismic-puzzle.png'; a.click();
      });
      
      document.getElementById('shareXBtn').addEventListener('click', ()=>{
        const timeTxt = timeEl.textContent.trim();
        const txt = [
          'Seismic Puzzle for @seismicsys',
          '',
          `I just solved the Seismic Puzzle in ${timeTxt}!`,
          '',
          `build by @crpbase | art by @dosunets`,
          '',
          'Try to beat my time: https://crpbase.github.io/Seismic_Puzzle/',
          '',
          '#ChallengeSeismicPuzzle'
        ].join('\n');
        const url='https://twitter.com/intent/tweet?text='+encodeURIComponent(txt);
        window.open(url,'_blank');
      });

      window.addEventListener('resize', resizeCanvas);
      initBoard();
      resizeCanvas();
    })();
  </script>
</body>
</html>
